name: Build iOS App
run-name: Build iOS App
on:
  push: # TODO: remove me
    branches:
      - main
  workflow_dispatch:

jobs:
  build-ios:
    name: "Build iOS"
    runs-on: macos-13
    timeout-minutes: 60
    environment:
      name: iOS
    defaults:
      run:
        working-directory: apps/rn-app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup environment
        uses: ./.github/actions/setup-environment
      - name: Prepare product info
        run: |
          # TODO: Read product info from environment variable.
          cp product.json5.example product.json5
      - name: Prebuild
        run: |
          yarn prebuild default ios
      - name: Install CocoaPods and Fastlane
        run: |
          gem install cocoapods:1.15.2 fastlane:2.219.0 rb_json5
          echo "CocoaPods version: $(pod --version)"
      - name: Cache Pods
        uses: actions/cache@v4
        env:
          cache-name: rn-app-pods
        with:
          path: apps/rn-app/ios/Pods
          key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('apps/rn-app/ios/Podfile') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.cache-name }}-
      - name: Pod install
        run: |
          yarn pod-install
      - name: Prepare code signing storage Git SSH private key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.CODE_SIGNING_STORAGE_GIT_SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo '[ERROR] Environment secret "CODE_SIGNING_STORAGE_GIT_SSH_PRIVATE_KEY" is not set.'
          fi
          ssh-agent sh -c 'echo "$SSH_PRIVATE_KEY"' | ssh-add -
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        env:
          cache-name: rn-app-ccache
        with:
          key: ${{ runner.os }}-${{ env.cache-name }}
      - name: Build
        env:
          ENVIRONMENT: ${{ vars.ENVIRONMENT }}
          CODE_SIGNING_STORAGE_GIT_URL: ${{ vars.CODE_SIGNING_STORAGE_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.CODE_SIGNING_STORAGE_PASSPHRASE }}
        run: |
          if [ -z "$ENVIRONMENT" ]; then
            echo '[ERROR] Environment variable "ENVIRONMENT" is not set.'
          fi
          if [ -z "$CODE_SIGNING_STORAGE_GIT_URL" ]; then
            echo '[ERROR] Environment variable "CODE_SIGNING_STORAGE_GIT_URL" is not set.'
          fi
          if [ -z "$MATCH_PASSWORD" ]; then
            echo '[ERROR] Environment secret "CODE_SIGNING_STORAGE_PASSPHRASE" is not set.'
          fi

          echo "export NODE_BINARY=$(command -v node)" > ios/.xcode.env.local

          export CCACHE_SLOPPINESS=clang_index_store,file_stat_matches,include_file_ctime,include_file_mtime,ivfsoverlay,pch_defines,modules,system_headers,time_macros
          export CCACHE_FILECLONE=true
          export CCACHE_DEPEND=true
          export CCACHE_INODECACHE=true

          CLANG=clang CLANGPLUSPLUS=clang++ LD=clang LDPLUSPLUS=clang++ fastlane ios build


      # - name: Prepare code signing certificates and profiles
      #   env:
      #     GIT_URL: ${{ vars.CODE_SIGNING_STORAGE_GIT_URL }}
      #     SSH_PRIVATE_KEY: ${{ secrets.CODE_SIGNING_STORAGE_GIT_SSH_PRIVATE_KEY }}
      #     MATCH_PASSWORD: ${{ secrets.CODE_SIGNING_STORAGE_PASSPHRASE }}
      #   # TODO: Replace RNApp.xcworkspace, "app.ztg.dev.study.rnapp202402"
      #   run: |
      #     if [ -z "$GIT_URL" ]; then
      #       echo '[ERROR] Environment variable "CODE_SIGNING_STORAGE_GIT_URL" is not set.'
      #     fi
      #     if [ -z "$SSH_PRIVATE_KEY" ]; then
      #       echo '[ERROR] Environment secret "CODE_SIGNING_STORAGE_GIT_SSH_PRIVATE_KEY" is not set.'
      #     fi
      #     if [ -z "$MATCH_PASSWORD" ]; then
      #       echo '[ERROR] Environment secret "CODE_SIGNING_STORAGE_PASSPHRASE" is not set.'
      #     fi

      #     ssh-agent sh -c 'echo "$SSH_PRIVATE_KEY"' | ssh-add -

      #     fastlane sync_code_signing development --readonly --storage_mode git --git_url "$GIT_URL" --app_identifier "app.ztg.dev.study.rnapp202402" --force_for_new_devices
      #     fastlane sync_code_signing appstore --readonly --storage_mode git --git_url "$GIT_URL" --app_identifier "app.ztg.dev.study.rnapp202402" --force_for_new_devices

      #     cd app/rn-app/ios
      #     fastlane update_project_provisioning --xcodeproj RNApp.xcworkspace --profile

      # - name: Debugging with ssh
      #   uses: lhotari/action-upterm@v1
      #   # with:
      #   #   limit-access-to-users: zetavg

      # - name: Build
      #   # TODO: replace RNApp.xcworkspace
      #   run: |
      #     fastlane build_app --workspace RNApp.xcworkspace --export_method app-store

      # # - name: Debugging with ssh
      # #   uses: lhotari/action-upterm@v1
